name: CI Tests
on: [push]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  UV_FROZEN: "1"
  UV_LINK_MODE: "symlink"

jobs:
  lint:
    name: "lint"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "~=0.9.2"

      - name: Prek
        run: uvx prek run --all-files

  linux-low:
    name: "linux-low"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "~=0.9.2"

    - name: Pytest
      run: uv run --python 3.10 --resolution "lowest-direct" pytest

  linux-high:
    name: "linux-high"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "~=0.9.2"

      - name: Mypy
        run: uv run mypy

      - name: Pytest
        run: uv run pytest --cov=src --cov-fail-under=90

      - name: Documentation
        run: |
          uv run --group doc -m sphinx \
              --jobs 2 \
              --fail-on-warning \
              -b html \
              docs \
              docs/_build/html

      - name: Upload static files as artifact
        id: deployment
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs/_build/html

  windows:
    name: "windows"
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "~=0.9.2"

      - name: Pytest
        run: uv run pytest
